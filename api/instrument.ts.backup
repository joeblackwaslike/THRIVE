import process from 'node:process';
import * as Sentry from '@sentry/node';
import dotenv from 'dotenv';
import logger from './logger.ts';

dotenv.config({ quiet: true });

if (!process.env.SENTRY_DSN) {
  logger.warn('SENTRY_DSN not configured - error tracking disabled');
}

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV || 'development',
  release: process.env.npm_package_version || '1.0.0',
  // Enable logs
  enableLogs: true,
  integrations: [
    // send console.log, console.warn, and console.error calls as logs to Sentry
    Sentry.consoleLoggingIntegration({ levels: ["debug", "info", "log", "warn", "error", "assert", "trace"] }),
  ],
  // Setting this option to true will send default PII data to Sentry.
  // For example, automatic IP address collection on events
  sendDefaultPii: true,
  // Performance monitoring
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  // Error sampling
  sampleRate: 1.0,
  // Enable profiling
  profilesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
  beforeSend(event) {
    // Filter out specific errors or add custom context
    logger.error('Error sent to Sentry:', {
      message: event.exception?.values?.[0]?.value,
      type: event.exception?.values?.[0]?.type,
      user: event.user?.id,
    });
    return event;
  },
});
